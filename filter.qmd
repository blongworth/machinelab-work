---
title: "filter LECS data"
format: html
editor: source
---

Filter all bad data out of raw dataset

Runs after processing csv files to a single Arrow dataset

Run before pH calibration.

```{r}
library(arrow)
library(tidyverse)
library(dygraphs)

data_dir <- "data/processed/surface"
```

Open dataset

```{r}
ds <- open_dataset(file.path(data_dir, "lecs_adv_data.parquet"))
```

# Filter

```{r}
ds_filt <- ds |> 
  filter(#!(timestamp > "2023-06-23 13:00:00" & timestamp < "2023-06-26 11:00:00"),
         ##!(time > "2023-06-23 13:00:00" & time < "2023-07-20 20:00:00"),
         !(timestamp > "2023-07-11 08:45:00" & timestamp < "2023-07-20 16:15:00"),
         !(timestamp > "2023-07-24 12:49:00" & timestamp < "2023-07-24 20:15:00"),
         !(timestamp > "2023-08-23 10:15:00" & timestamp < "2023-08-23 12:10:00"),
         !(timestamp > "2023-08-27 03:56:00" & timestamp < "2023-09-11 12:15:00"),
         !(timestamp > "2023-09-15 00:07:00" & timestamp < "2023-10-17 16:00:00"),
         !(timestamp > "2023-10-19 07:30:00" & timestamp < "2023-10-19 08:25:00"),
         !(timestamp > "2023-12-22 06:45:00" & timestamp < "2023-12-22 07:15:00"),
         !(timestamp > "2024-01-28 00:00:00" & timestamp < "2024-02-08 10:00:00"),
         !(timestamp > "2024-02-13 00:00:00" & timestamp < "2024-03-13 18:00:00"),
         !(timestamp > "2024-03-22 08:35:00" & timestamp < "2024-03-22 09:26:00"),
         !(timestamp > "2024-04-01 07:09:00" & timestamp < "2024-04-01 07:20:00"),
         !(timestamp > "2024-06-03 08:50:00" & timestamp < "2024-06-03 09:45:00"),
         !(timestamp > "2024-06-05 10:50:00" & timestamp < "2024-06-05 11:40:00"),
         !(timestamp > "2024-08-27 06:30:00" & timestamp < "2024-08-27 07:35:00"),
         timestamp < "2024-09-27 06:13:00",
         pressure > 0.2,
         pressure < 3,
         temp > 0,
         temp < 30,
         corr1 <= 100,
         corr2 <= 100,
         corr3 <= 100,
         pH > 7.18,
         pH < 10,
         ox_umol_l < 450,
         ox_umol_l > 90) |> 
  mutate(ph_counts = if_else(timestamp > "2023-07-21 00:00:00", ph_counts, NA))
```
# Save data

```{r}
ds_filt %>% 
  group_by(year = year(timestamp), month = month(timestamp)) %>% 
  write_dataset(file.path(data_dir, "lecs_adv_filt.parquet"))
```