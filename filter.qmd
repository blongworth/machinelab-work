---
title: "filter LECS data"
format: html
editor: source
---

Filter all bad data out of raw dataset

Runs after processing csv files to a single Arrow dataset

Run before pH calibration.

```{r}
library(arrow)
library(tidyverse)
library(dygraphs)

data_dir <- "data/processed/surface"
```

Open dataset

```{r}
ds <- open_dataset(file.path(data_dir, "lecs_adv_data.parquet"))
```

# Filter

```{r}
ds_filt <- ds |> 
  filter(#!(timestamp > "2023-06-23 13:00:00" & timestamp < "2023-06-26 11:00:00"),
         ##!(time > "2023-06-23 13:00:00" & time < "2023-07-20 20:00:00"),
         !(timestamp > "2023-08-27 04:00:00" & timestamp < "2023-09-11 16:20:00"),
         !(timestamp > "2023-09-15 04:00:00" & timestamp < "2023-10-17 16:00:00"),
         !(timestamp > "2023-12-22 11:45:00" & timestamp < "2023-12-22 12:45:00"),
         !(timestamp > "2024-01-28 00:00:00" & timestamp < "2024-02-08 10:00:00"),
         !(timestamp > "2024-02-13 00:00:00" & timestamp < "2024-03-13 18:00:00"),
         pressure > 0.2,
         pressure < 3,
         temp > 0,
         temp < 30,
         pH > 7.18,
         pH < 10,
         ox_umol_l < 450,
         ox_umol_l > 90) |> 
  mutate(ph_counts = if_else(timestamp > "2023-07-21 00:00:00", ph_counts, NA))
```
# Save data

```{r}
ds_filt %>% 
  group_by(year = year(timestamp), month = month(timestamp)) %>% 
  write_dataset(file.path(data_dir, "lecs_adv_filt.parquet"))
```